<!DOCTYPE HTML>
<html lang='ko'>

<head>
	<title>Marina</title>
	<meta charset='utf-8'>
	<meta name='Viewport'
		content='width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=2.0, minimum-scale=1.0'>
	<meta name='Title' content=''>
	<meta name='Subject' content=''>
	<meta name='format-detection' content='telephone=no'>
	<meta name='Publisher' content=''>
	<meta name='Keywords' content=''>
	<meta name='Description' content=''>
	<meta name='Author' content=''>
	<meta name='Author-Date' content=''>
	<meta name='Copyright' content=''>
	<meta name='Robots' content=''>

	<!-- 파비콘 -->
	<link rel='shortcut icon' href='./img/'>
	<link rel='apple-touch-icon' href='./img/'>

	<!-- 스타일 -->
	<link rel='stylesheet' href='./css/reset.css' type='text/css'>
	<link rel='stylesheet' href='./css/fonts.css' type='text/css'>
	<link rel='stylesheet' href='./css/style1_1.css' type='text/css'>
	<link rel='stylesheet' href='./css/style_header.css' type='text/css'>

	<!-- js라이브러리 -->
	<script src='./js/lib/jquery-1.12.4.min.js'></script>
	<script src='./js/lib/jquery.easing.1.3.js'></script>
	<script src='./js/lib/jquery.touchSwipe.js'></script>

	<!-- 아이콘 폰트어썸 -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<script src='./js/lib/jquery-1.12.4.min.js'></script>

	<!-- 각 브라우저 CSS호환 -->
	<!-- <script src='./js/lib/prefixfree.min.js'></script> -->


	<script src="/socket.io/socket.io.js"></script>
	<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
	<script language="JavaScript">

		// 공통 header
		$(document).ready(function () {
			$("#header").load("header.html")
		});



		const socket = io();
		//key값 설정(html 입력 id = '' 값 )
		const params = ['user_id','user_cd', 'user_nm', 'telephone', 'email'];
		var num = 0, image, clickMemberData = new Object(),target_img;

		//입력값 초기화
		function Default_InPut(data) {
			for (var i = 0; i < data.length; i++)
				document.getElementById(data[i]).value = "";
		}

		//이미지값 출력
		function setThumbnail(event) {
			var reader = new FileReader();

			//이미지 초기화(사진 겹침 방지)
			$("div#image_container").empty();

			//파일 이미지 찾기
			reader.onload = function (event) {
				var img = document.createElement("img");
				
				target_img=event.target.result;


				img.setAttribute("src", event.target.result);
				document.querySelector("div#image_container").appendChild(img);

			};

			// 이미지 출력
			reader.readAsDataURL(event.target.files[0]);
			image = event.target.files[0];


		}


		//회원관리 조회(조회)
		function search_button() {
			const search = document.getElementById('t_search').value;

			//출력값 초기화
			num = 0;
			$("#user_log").empty();

			//data전송
			socket.emit('search_data', search);


			//입력값 초기화
			Default_InPut(params);
		}

		//회원관리 조회값 출력
		socket.on('search', function (data) {
			// 검색어 초기화
			document.getElementById('t_search').value = "";

			// 출력값 구성 잡기
			$("#user_log").append($("<li class=search_members id=search" + num + ">"));
			for (var key in data)
				if (key == 'user_id' || key == 'user_nm' || key == 'telephone' || key == 'email')
					$('#search' + num).append($('<span>').text(data[key]));

			/**/
			//해당 회원 클릭시
			var target = document.querySelectorAll(".search_members");
			target[num].addEventListener("click", function (res) {
				// var path = res.path[6].children[4].children[0].children

				//출력 내용
				for (var i = 0; i < params.length; i++) {
					clickMemberData[params[i]] = data[params[i]];
					document.getElementById(params[i]).value = data[params[i]];
				}

				//data 전송(이미지 출력을 위한)
				socket.emit('click_members_search', clickMemberData);

				// 데이터 전송
				socket.emit(PAGE_NAME1 + 'save_data', { click: true, new: false });
			});

			num++;

			//이미지 초기화(사진 겹침 방지)
			$("div#image_container").empty();


		})

		//해당클릭 회원 사진 출력
		socket.on('click_members', function (data) {
			var img = document.createElement("img");

			image = data.picture;
			//이미지 초기화(사진 겹침 방지)
			$("div#image_container").empty();

			// 이미지 출력
			img.setAttribute("src", image);
			document.querySelector("div#image_container").appendChild(img);

		})



		//신규 회원 저장(신규)
		function new_button() {
			// 데이터 전송
			socket.emit('save_data', { click: false, new: true });

			//입력값 초기화
			Default_InPut(params);

			//이미지 초기화(사진 겹침 방지)
			$("div#image_container").empty();


			/* 신규만 눌럿을 적용한 스크립트
			var sendData = new Object();

			//데이터 Json으로 저장
			for (var i = 0; i < params.length; i++)
				sendData[params[i]] = document.getElementById(params[i]).value;

			// 데이터 전송
			socket.emit('save_data', sendData);

			//입력값 초기화
			Default_InPut(params);

			// ajax 데이터 보낼 내용 가공
			var data = new FormData();
			data.append('image_Data_Param', JSON.stringify(sendData));
			data.append('image_Data_Param', image);

			//이미지 값 전송
			$.ajax({
				url: '/img/post',
				type: 'POST',
				data: data,
				processData: false,
				contentType: false,
				success: function (data) {
					console.log(data)
				}
			});

			//이미지 초기화(사진 겹침 방지)
			data.delete('image_Data_Param');
			$("div#image_container").empty();

			//출력값 초기화
			num = 0;
			$("#user_log").empty();
			*/

		}

		// count된 ID 출력
		socket.on('search_count',function(data){
			document.getElementById('user_id').value = data.max+1;

		});

		//회원관리 수정(저장)
		function save_button() {
			var sendData = new Object();

			//데이터 Json으로 저장
			for (var i = 0; i < params.length; i++)
				sendData[params[i]] = document.getElementById(params[i]).value;

			// 데이터 전송
			socket.emit('update_data', { search: clickMemberData, change: sendData });

			// 입력값 초기화
			Default_InPut(params);

			// ajax 데이터 보낼 내용 가공
			var data = new FormData();

			data.append('image_Data_Param', target_img);
			// data.append('image_Data_Param', JSON.stringify(sendData));

			//이미지 값 전송
			$.ajax({
				url: '/img/post',
				type: 'POST',
				data: data,
				processData: false,
				contentType: false
			});

			//이미지 초기화(사진 겹침 방지)
			data.delete('image_Data_Param');
			$("div#image_container").empty();

			//출력값 초기화
			num = 0;
			$("#user_log").empty();

		}



		//회원관리 삭제(삭제)
		function delete_button() {
			var sendData = new Object();

			//데이터 Json으로 저장
			for (var i = 0; i < params.length; i++)
				sendData[params[i]] = document.getElementById(params[i]).value;

			// 데이터 전송
			socket.emit('delete_data', sendData);
			
			//입력값 초기화
			Default_InPut(params);

			//출력값 초기화
			num = 0;
			$("#user_log").empty();

			//이미지 초기화(사진 겹침 방지)
			$("div#image_container").empty();
		}


		//출입내역 조회
		function search() {
			const sendData = new Object();
			const params = ['startDay', 'endDay', 'userName']

			//데이터 Json으로 저장
			for (var i = 0; i < params.length; i++)
				sendData[params[i]] = (document.getElementById(params[i]).value).replace(/\-/g, "");

			// 데이터 전송
			socket.emit('search_inout_data', sendData);

			//입력값 초기화
			// Default_InPut(params);

			// 출력값 초기화
			$(".outBoard_wrap ul #user_log").empty();
			num = 0;

		}


		//출입내역 조회값 출력
		socket.on('search_inout', function (data) {

			$(".outBoard_wrap ul #user_log").append($("<li id=search_inout" + num + ">"));

			for (var key in data)
				if (key == 'reg_date' || key == 'dvc_nm' || key == 'user_nm' || key == 'status')
					$('#search_inout' + num).append($('<span>').text(data[key]));

			num++;
		})


	</script>


</head>

<body>
	<div id='wrap' class='clearfix'>

		<header id='header'></header>

		<main id='main'>
			<div class='gap'>
				<div class='container'>

					<div class='title'>
						<h2>회원관리</h2>
					</div>

					<input id="tab1" type="radio" name="tabs" checked>
					<label class='tabs' for="tab1">회원기초 정보관리</label>
					<input id="tab2" type="radio" name="tabs">
					<label class='tabs' for="tab2">출입내역 조회</label>

					<span class='sub2Menu_line'></span>

					<section id='section1' class='clearfix'>
						<div class='search_wrap'>
							<input type='text' name='t_search' id='t_search' class='inputText' value=''
								placeholder='회원코드 또는 회원명을 입력하세요.'>
						</div>

						<div class='button_wrap'>
							<ul class='clearfix'>
								<li>
									<div>
										<input type='submit' id='delete' class='delete' onclick="delete_button();"
											value='삭제'>
									</div>
								</li>
								<li>
									<div>
										<input type='submit' id='save' class='save' onclick="save_button();" value='저장'>
									</div>
								</li>
								<li>
									<div>
										<input type='submit' id='new' class='new' onclick="new_button();" value='신규'>
									</div>
								</li>
								<li>
									<div>
										<input type='submit' id='search' class='search' onclick="search_button();"
											value='조회'>
									</div>
								</li>
							</ul>
						</div>

						<div class='user_board board_wrap'>
							<ul>
								<li class='clearfix'>
									<span>회원 ID</span>
									<span>회원명</span>
									<span>연락처</span>
									<span>이메일</span>
								</li>
								<li>
									<ul id="user_log"></ul>
								</li>
							</ul>
						</div>

						<div class='notice-page'>
							<ul>
								<li><div><a href='javascript:' class='pagePrevBtn'><img src='./img/btn_page_prev.png' alt=''></a></div></li>
								<li class='pageBtn-wrap'>
		
									<!-- AJAX 바인딩 내용 -->
		
								</li>
								<li><div><a href='javascript:' class='pageNextBtn'><img src='./img/btn_page_next.png' alt=''></a></div></li>
							</ul>
						</div>	

						<div class='userJoin_wrap'>
							<ul class='clearfix'>
								<li>
									<div>
										<ul class='clearfix'>
											<li>
												<div>
													<h2>회원ID</h2>
													<h2>회원코드</h2>
													<h2>회원명</h2>
													<h2>연락처</h2>
													<h2>이메일</h2>
												</div>
											</li>
											<li>
												<div>
													<input type='text' id='user_id' placeholder='' readonly>
													<input type='text' name='code' id='user_cd' placeholder='회원코드를 입력하세요.'>
													<input type='text' name='name' id='user_nm' placeholder='이름을 입력하세요.'>
													<input type='text' name='tel' id='telephone' placeholder='휴대폰 번호를 입력하세요.'>
													<input type='text' name='email' id='email' value='' placeholder='이메일을 입력하세요.'>
												</div>
											</li>
										</ul>
									</div>
								</li>
								<li>
									<div>
										<div id="image_container"></div>
										<label class='imgOpen' for='imageFileOpenInput'>
											얼굴 등록
										</label>

										<input type="file" name="file" id="imageFileOpenInput" accept="image/*"
											onchange="setThumbnail(event);">

									</div>
								</li>
							</ul>
						</div>
					</section>

					<section id='section2'>
						<div class='outSearch_wrap'>
							<ul class='clearfix'>
								<li>
									<h2 class='outSearchText'>조회 기간</h2>
									<h3 class='outSearchText'>회원명</h3>
								</li>
								<li>
									<input type='date' name='userDay' id='startDay' value='yyyy-mm-dd'>
									<span class="demi">~</span>
									<input type='date' name='userDay' id='endDay' value='yyyy-mm-dd'>
									<input type='text' name='userName' id='userName' class='inputText' value=''
										placeholder='회원코드 또는 회원명을 입력하세요.'>
									<input type='submit' id='search' class='search' onclick="search();" value='조회'>
								</li>
							</ul>
						</div>

						<div class='outBoard_wrap board_wrap'>
							<ul>
								<li class='clearfix'>
									<span>출입일시</span>
									<span>장치명</span>
									<span>회원명</span>
									<span>상태</span>
								</li>
								<li>
									<ul id="user_log"></ul>
								</li>
							</ul>
						</div>
					</section>

				</div>
			</div>
		</main>

		<script src="./js/marina.js"></script>

	</div>
</body>

</html>